---
keywords: [intermediate, tutorial, identity, credentials, verifiable credentials, relying party]
---

import { MarkdownChipRow } from "/src/components/Chip/MarkdownChipRow";
import useBaseUrl from "@docusaurus/useBaseUrl";

# Become a relying party

<MarkdownChipRow labels={["Intermediate", "Tutorial"]} />

## Overview

Llorenç Muntaner Perello to add any links / thoughts for what we have now?
https://github.com/dfinity/internet-identity/blob/main/docs/vc-spec.md
Demo: https://github.com/dfinity/vc-playground/tree/main/rp/frontend
II Slides on attribute sharing for ICP Explained
https://github.com/dfinity/verifiable-credentials-sdk/tree/main/js-library
Outline
Request credentials to issuers through an identity provider that supports the verifiable credentials specification. Typically Internet Identity.
Requirement: The user is logged in with the identity provider.
Two steps
Request credentials. How to use the JS library
More details on how the flow works are in “How it Works” section or the specifications document.
Verify the credentials. Explanation
Example: https://github.com/dfinity/vc-playground/blob/b2f8cd5f5397b7b355b6503df5af3789834b79e9/rp/src/main.rs#L262


##  Using the identity provider API

This section describes the [_`window.postMessage()`_](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage)-interface implemented by the identity provider (Internet Identity).
This interface is used by a Relying Party during attribute sharing flow (cf. [flow description](https://github.com/dfinity/wg-identity-authentication/blob/main/topics/attribute-sharing.md))

### 1: Load II in a new window

The II window needs to be opened with the URL path `/vc-flow`.

After opening the II window, II will load and notify `window.opener` with the following JSON-RPC notification:

```json
{
  "jsonrpc": "2.0",
  "method": "vc-flow-ready"
}
```

### 2: Request a VC

After receiving the notification that II is ready, the relying party can request a VC by sending the following JSON-RPC request:
* Method: `request_credential`
* Params:
  * `issuer`: An issuer that the relying party trusts. It has the following properties:
    * `origin`: The origin of the issuer.
    * `canisterId`: (optional) The canister id of the issuer, if applicable/known. If specified and not the same
       as the one reported by a boundary node for `origin`, this is an error.
  * `credentialSpec`: The spec of the credential that the relying party wants to request from the issuer.
    * `credentialType`: The type of the requested credential.
    * `arguments`: (optional) A map with arguments specific to the requested credentials. It maps string keys to values that must be either strings or integers.
  * `credentialSubject`: The subject of the credential as known to the relying party. Internet Identity will use this principal to ensure that the flow is completed using the matching identity.
  * `derivationOrigin`: (optional) The origin that should be used for principal derivation (instead of the client origin) during the verification of `credentialSubject` (applicable if the relying party
        uses the [Alternative Frontend Origins](https://internetcomputer.org/docs/current/references/ii-spec#alternative-frontend-origins)-feature).

#### Examples

```json
{
  "id": 1,
  "jsonrpc": "2.0",
  "method": "request_credential",
  "params": {
    "issuer": {
        "origin": "https://employment-info.com",
        "canisterId": "rwlgt-iiaaa-aaaaa-aaaaa-cai"
    },
    "credentialSpec": {
        "credentialType": "VerifiedEmployee",
        "arguments": {
          "employerName": "XYZ Ltd."
        }
    },
    "credentialSubject": "2mdal-aedsb-hlpnv-qu3zl-ae6on-72bt5-fwha5-xzs74-5dkaz-dfywi-aqe"
  }
}
```

```json
{
  "id": 1,
  "jsonrpc": "2.0",
  "method": "request_credential",
  "params": {
    "issuer": {
        "origin": "https://kyc-star.com",
        "canisterId": "rdmx6-jaaaa-aaaaa-aaadq-cai"
    },
    "credentialSpec": {
        "credentialType": "VerifiedAdult",
        "arguments": {
            "minAge": 21
        }
    },
    "credentialSubject": "s33qc-ctnp5-ubyz4-kubqo-p2tem-he4ls-6j23j-hwwba-37zbl-t2lv3-pae",
    "derivationOrigin": "https://vt36r-2qaaa-aaaad-aad5a-cai.icp0.io"
  }
}
```

```json
{
  "id": 1,
  "jsonrpc": "2.0",
  "method": "request_credential",
  "params": {
    "issuer": {
        "origin": "https://kyc-resident-info.org"
    },
    "credentialSpec": {
        "credentialType": "VerifiedResident",
        "arguments": {
            "countryName": "Panama",
            "countryAlpha2": "PA"
        }
    },
    "credentialSubject": "cpehq-54hef-odjjt-bockl-3ldtg-jqle4-ysi5r-6bfah-v6lsa-xprdv-pqe"
  }
}
```

### 3: Get a Response


#### Receive a Verifiable Presentation

After the user has successfully completed the flow, Internet Identity will respond with the following JSON-RPC response:

  * `verifiablePresentation`: The JWT based verifiable presentation containing two credentials:
    1. A verifiable credential issued by Internet Identity that relates the requested `credentialSubject` to another alias principal.
    2. A verifiable credential issued by the requested issuer to the alias principal.

**NOTE:** the order of the credentials in the presentation should match the list above,
i.e. the credential that relates the subject to alias principal should come first.

##### Example

```json
{
  "id": 1,
  "jsonrpc": "2.0",
  "result": {
    "verifiablePresentation": "eyJQ..."
  }
}
```

An example of such a verifiable presentation can be found [here](https://www.w3.org/TR/vc-data-model/#example-jwt-payload-of-a-jwt-based-verifiable-presentation-non-normative).

#### Receive an Error Message

If the flow failed for any reason, Internet Identity returns an error.
For privacy protection, the error does not give any details on the root cause of the failure.
(This may change in the future, as some failures can be reported to the relying
party without impacting user's privacy.)

##### Example

``` json
{
    "id": 1,
    "jsonrpc": "2.0",
    "error": {
        "version": "1",
        "code": "UNKNOWN"
    }
}
```

## Endpoints

### `derivation_origin`

What it is
What does it verify/validate
Best practices

### `vc_consent_message`

### `prepare_credential`

### `get_credential`


## Resources

- [Verifiable credentials specification](https://github.com/dfinity/internet-identity/blob/main/docs/vc-spec.md)

- [Issuer demo](https://github.com/dfinity/vc-playground/blob/main/issuer/src/main.rs)



### Recommended convention connecting credential specification with the returned credentials.

Service discovery and syntax of the claims in the returned credentials are out of scope
of this spec (of the MVP service).  However, an issuer may follow the convention below,
for an easier verification of the returned credentials.

Given a credential spec like
```json
    "credentialSpec": {
        "credentialType": "SomeVerifiedProperty",
        "arguments": {
            "argument_1": "value_1",
            "another_argument": 42,
        }
```
the returned JWT should contain in `credentialSubject` a property
named by the value of `credentialType` from the spec, with key-value
entries listing the arguments from the spec, namely
```json
    "SomeVerifiedProperty": {
        "argument_1": "value_1",
        "another_argument": 42,
    }
```

For example, for `VerifiedAdult`-credential we'd use the following credential spec
```json
    "credentialSpec": {
        "credentialType": "VerifiedAdult",
        "arguments": {
            "minAge": 18,
    }
```
and a compliant issuer would issue a VC that contains `credentialSubject` with the property
```json
    "VerifiedAdult": {
        "minAge": 18,
    }
```




#### Interaction Model

Given the interactive nature of the flow, the relying party should not expect to receive a response immediately. Instead, the relying party should wait for one of the following events:
* II sends a JSON-RPC response as described above.
* II sends a JSON-RPC error response.
* The user closes the II window. This should be treated as an error.

The relying party may also close the II window after some timeout. The user should then be notified by the relying party that the flow failed.


